(()=>{var Q=Object.create;var M=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var P=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Z=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of V(e))!Y.call(r,i)&&i!==t&&M(r,i,{get:()=>e[i],enumerable:!(n=B(e,i))||n.enumerable});return r};var ee=(r,e,t)=>(t=r!=null?Q(X(r)):{},Z(e||!r||!r.__esModule?M(t,"default",{value:r,enumerable:!0}):t,r));var G=P((me,E)=>{"use strict";var f=typeof Reflect=="object"?Reflect:null,O=f&&typeof f.apply=="function"?f.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},C;f&&typeof f.ownKeys=="function"?C=f.ownKeys:Object.getOwnPropertySymbols?C=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:C=function(e){return Object.getOwnPropertyNames(e)};function te(r){console&&console.warn&&console.warn(r)}var W=Number.isNaN||function(e){return e!==e};function a(){a.init.call(this)}E.exports=a;E.exports.once=oe;a.EventEmitter=a;a.prototype._events=void 0;a.prototype._eventsCount=0;a.prototype._maxListeners=void 0;var R=10;function b(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return R},set:function(r){if(typeof r!="number"||r<0||W(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");R=r}});a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};a.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||W(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function j(r){return r._maxListeners===void 0?a.defaultMaxListeners:r._maxListeners}a.prototype.getMaxListeners=function(){return j(this)};a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",o=this._events;if(o!==void 0)i=i&&o.error===void 0;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var u=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw u.context=s,u}var p=o[e];if(p===void 0)return!1;if(typeof p=="function")O(p,this,t);else for(var _=p.length,J=D(p,_),n=0;n<_;++n)O(J[n],this,t);return!0};function N(r,e,t,n){var i,o,s;if(b(t),o=r._events,o===void 0?(o=r._events=Object.create(null),r._eventsCount=0):(o.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),o=r._events),s=o[e]),s===void 0)s=o[e]=t,++r._eventsCount;else if(typeof s=="function"?s=o[e]=n?[t,s]:[s,t]:n?s.unshift(t):s.push(t),i=j(r),i>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=r,u.type=e,u.count=s.length,te(u)}return r}a.prototype.addListener=function(e,t){return N(this,e,t,!1)};a.prototype.on=a.prototype.addListener;a.prototype.prependListener=function(e,t){return N(this,e,t,!0)};function re(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function S(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=re.bind(n);return i.listener=t,n.wrapFn=i,i}a.prototype.once=function(e,t){return b(t),this.on(e,S(this,e,t)),this};a.prototype.prependOnceListener=function(e,t){return b(t),this.prependListener(e,S(this,e,t)),this};a.prototype.removeListener=function(e,t){var n,i,o,s,u;if(b(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(o=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){u=n[s].listener,o=s;break}if(o<0)return this;o===0?n.shift():ne(n,o),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,u||t)}return this};a.prototype.off=a.prototype.removeListener;a.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var o=Object.keys(n),s;for(i=0;i<o.length;++i)s=o[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function U(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?ie(i):D(i,i.length)}a.prototype.listeners=function(e){return U(this,e,!0)};a.prototype.rawListeners=function(e){return U(this,e,!1)};a.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):H.call(r,e)};a.prototype.listenerCount=H;function H(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?C(this._events):[]};function D(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function ne(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function ie(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function oe(r,e){return new Promise(function(t,n){function i(s){r.removeListener(e,o),n(s)}function o(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}F(r,e,o,{once:!0}),e!=="error"&&se(r,i,{once:!0})})}function se(r,e,t){typeof r.on=="function"&&F(r,"error",e,t)}function F(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(o){n.once&&r.removeEventListener(e,i),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var $=P(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.TypedEmitter=G().EventEmitter});var l=class{getAccessToken;constructor(e){this.getAccessToken=e}async get(e){let t={"Content-Type":"application/json"},n=this.getAccessToken();n&&(t.Authorization=`Bearer ${n}`);let i=await fetch(process.env.API_SERVER+"/api"+e,{method:"GET",headers:t});if(i.status===404)throw new y("Not found",i.status);if(!i.ok)throw new k("Internal server error",i.status);return i.json()}async post(e,t){let n={"Content-Type":"application/json"},i=this.getAccessToken();i&&(n.Authorization=`Bearer ${i}`);let o=await fetch(process.env.API_SERVER+"/api"+e,{method:"POST",headers:n,body:JSON.stringify(t)});if(o.status===404)throw new y("Not found",o.status);if(!o.ok)throw new k("Internal server error",o.status);return o.json()}},T=class{constructor(e,t){this.message=e;this.status=t}},y=class extends T{},k=class extends T{};var q=ee($(),1);var c=class{api;element;iframe=null;unregister=[];constructor(e,t){this.api=e,this.element=t,this.unregister.push(this.api.on("customerChanged",i=>{this.build(i)})),this.unregister.push(this.api.on("refreshToken",i=>{this.message({type:"refreshCustomerToken",customerToken:i})})),this.unregister.push(this.api.on("customerLogout",()=>{this.handleLogout()}));let n=this.api.getCustomerToken();n?this.build(n):this.handleLogout()}handleLogout(){this.iframe=null,this.element.innerHTML="No Customer Token"}destroy(){for(let e of this.unregister)e();this.iframe=null,this.element.innerHTML=""}build(e){}message(e){this.iframe?.contentWindow?.postMessage(e)}};var m=class extends c{insertArticles;containerId;constructor(e,t,n,i){super(e,t),this.insertArticles=n,this.containerId=i}build(e){this.element.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/widget?customerToken=${e}`,this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe)}};var h=class extends c{build(e){this.element.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/cart?customerToken=${e}`,this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe)}};var d=class{api;element=null;iframe=null;unregister=[];constructor(e){this.api=e,this.unregister.push(this.api.on("customerChanged",n=>{this.build(n)})),this.unregister.push(this.api.on("refreshToken",n=>{this.message({type:"refreshCustomerToken",customerToken:n})})),this.unregister.push(this.api.on("customerLogout",()=>{this.destroy()}));let t=this.api.getCustomerToken();t?this.build(t):this.destroy()}destroy(){for(let e of this.unregister)e();this.iframe=null,this.element&&(this.element.remove(),this.element=null)}build(e){}message(e){this.iframe?.contentWindow?.postMessage(e)}};var v=class extends d{build(e){this.element=document.createElement("div"),this.element.style.position="fixed",this.element.style.backdropFilter="blur(10px)",this.element.style.top="0",this.element.style.left="0",this.element.style.height="100%",this.element.style.width="100%",this.element.style.padding="2rem",this.element.style.boxSizing="border-box",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/app?customerToken=${e}`,this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe),document.body.append(this.element)}};function A(r){this.message=r}A.prototype=new Error,A.prototype.name="InvalidCharacterError";var z=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(r){var e=String(r).replace(/=+$/,"");if(e.length%4==1)throw new A("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,n,i=0,o=0,s="";n=e.charAt(o++);~n&&(t=i%4?64*t+n:n,i++%4)?s+=String.fromCharCode(255&t>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return s};function ae(r){var e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(z(t).replace(/(.)/g,function(n,i){var o=i.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}(e)}catch{return z(e)}}function L(r){this.message=r}function ue(r,e){if(typeof r!="string")throw new L("Invalid token specified");var t=(e=e||{}).header===!0?0:1;try{return JSON.parse(ae(r.split(".")[t]))}catch(n){throw new L("Invalid token specified: "+n.message)}}L.prototype=new Error,L.prototype.name="InvalidTokenError";var I=ue;var g=class{config;httpClient;getCustomerTokenCallback;customerToken=null;eventEmitter=new q.TypedEmitter;appWidget=null;refreshTimeout=null;retryCounter=0;constructor(e,t){this.config={appUrl:"https://tecsafe.github.io/app-ui/",...t},this.getCustomerTokenCallback=e,this.httpClient=new l(()=>{if(this.customerToken===null)throw new Error("missing customer token");return this.customerToken}),window.addEventListener("message",n=>{this.listenMessage(n.data)})}async initialize(){await this.reloadToken()}productDetailWidget(e,t,n){return new m(this,e,t,n)}cartWidget(e){return new h(this,e)}openApp(){return this.appWidget?this.appWidget:(this.appWidget=new v(this),this.appWidget)}closeApp(){this.appWidget&&(this.appWidget.destroy(),this.appWidget=null)}async reloadToken(){try{let e=await this.getCustomerTokenCallback();if(e===this.customerToken)return;if(e===null){this.logout();return}let t=I(e);if(this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.refreshTimeout=setTimeout(()=>{this.reloadToken()},(t.exp-30)*1e3-Date.now()),this.customerToken&&I(this.customerToken).sub===t.sub){this.customerToken=e,this.retryCounter=0,this.eventEmitter.emit("refreshToken",e);return}this.customerToken=e,this.retryCounter=0,this.eventEmitter.emit("customerChanged",e)}catch(e){if(console.error(e),this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.retryCounter<3){console.warn(`retry in 5 seconds (${this.retryCounter+1}/3)`),this.retryCounter++,this.refreshTimeout=setTimeout(()=>{this.reloadToken()},5e3);return}this.logout()}}logout(){this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.customerToken=null,this.eventEmitter.emit("customerLogout")}getCustomerToken(){return this.customerToken}async getCart(){return this.httpClient.get("/cart")}on(e,t){return this.eventEmitter.on(e,t),()=>{this.eventEmitter.off(e,t)}}off(e,t){this.eventEmitter.off(e,t)}emit(e,...t){this.eventEmitter.emit(e,...t)}listenMessage(e){switch(e.type){case"addToCart":this.eventEmitter.emit("addToCart",e.itemId,e.quantity,e.price);break;case"removeFromCart":this.eventEmitter.emit("removeFromCart",e.itemId);break;case"changeCartQuantity":this.eventEmitter.emit("changeCartQuantity",e.itemId,e.quantity,e.price);break;case"openApp":this.openApp();break;case"closeApp":this.closeApp();break}}};async function ce(r,e){let t=new g(r,e);return await t.initialize(),t}var K={initializeTecsafeApi:ce};var w=class extends Plugin{api;async init(){this.api=await K.initializeTecsafeApi(async()=>(await(await fetch("/tecsafe/ofcp/token")).json()).token)}reloadToken(){this.api.reloadToken()}logout(){this.api.logout()}createProductDetailWidget(e){return this.api.productDetailWidget(e)}},fe=window.PluginManager;fe.register("Tecsafe",w,"[data-tecsafe-plugin]");})();
