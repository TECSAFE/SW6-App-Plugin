"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["mad-tecsafe"],{4223:(e,t,i)=>{var r=i(6612);class s{constructor(e){this.getAccessToken=e}async get(e){let t={"Content-Type":"application/json"};const i=this.getAccessToken();i&&(t.Authorization=`Bearer ${i}`);const r=await fetch(process.env.API_SERVER+"/api"+e,{method:"GET",headers:t});if(404===r.status)throw new o("Not found",r.status);if(!r.ok)throw new a("Internal server error",r.status);return r.json()}async post(e,t){let i={"Content-Type":"application/json"};const r=this.getAccessToken();r&&(i.Authorization=`Bearer ${r}`);const s=await fetch(process.env.API_SERVER+"/api"+e,{method:"POST",headers:i,body:JSON.stringify(t)});if(404===s.status)throw new o("Not found",s.status);if(!s.ok)throw new a("Internal server error",s.status);return s.json()}}class n{constructor(e,t){this.message=e,this.status=t}}class o extends n{}class a extends n{}var h=i(133);class u{iframe=null;unregister=[];constructor(e,t){this.api=e,this.element=t,this.unregister.push(this.api.on("customerChanged",(e=>{this.build(e)}))),this.unregister.push(this.api.on("refreshToken",(e=>{this.message({type:"refreshCustomerToken",customerToken:e})}))),this.unregister.push(this.api.on("customerLogout",(()=>{this.handleLogout()})));const i=this.api.getCustomerToken();i?this.build(i):this.handleLogout()}handleLogout(){this.iframe=null,this.element.innerHTML="No Customer Token"}destroy(){for(const e of this.unregister)e();this.iframe=null,this.element.innerHTML=""}build(e){}message(e){this.iframe?.contentWindow?.postMessage(e)}}class l extends u{constructor(e,t,i,r){super(e,t),this.insertArticles=i,this.containerId=r}build(e){this.element.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/widget?customerToken=${e}`,this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe)}}class c extends u{build(e){this.element.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/cart?customerToken=${e}`,this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe)}}class m{element=null;iframe=null;unregister=[];constructor(e){this.api=e,this.unregister.push(this.api.on("customerChanged",(e=>{this.build(e)}))),this.unregister.push(this.api.on("refreshToken",(e=>{this.message({type:"refreshCustomerToken",customerToken:e})}))),this.unregister.push(this.api.on("customerLogout",(()=>{this.destroy()})));const t=this.api.getCustomerToken();t?this.build(t):this.destroy()}destroy(){for(const e of this.unregister)e();this.iframe=null,this.element&&(this.element.remove(),this.element=null)}build(e){}message(e){this.iframe?.contentWindow?.postMessage(e)}}class p extends m{build(e){this.element=document.createElement("div"),this.element.style.position="fixed",this.element.style.backdropFilter="blur(10px)",this.element.style.top="0",this.element.style.left="0",this.element.style.height="100%",this.element.style.width="100%",this.element.style.padding="2rem",this.element.style.boxSizing="border-box",this.iframe=document.createElement("iframe"),this.iframe.src=`${this.api.config.appUrl}/iframe/app?customerToken=${e}`,this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.backgroundColor="transparent",this.iframe.style.border="none",this.element.appendChild(this.iframe),document.body.append(this.element)}}function d(e){this.message=e}d.prototype=new Error,d.prototype.name="InvalidCharacterError";var f="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new d("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,r,s=0,n=0,o="";r=t.charAt(n++);~r&&(i=s%4?64*i+r:r,s++%4)?o+=String.fromCharCode(255&i>>(-2*s&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return o};function g(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(f(e).replace(/(.)/g,(function(e,t){var i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i})))}(t)}catch(e){return f(t)}}function y(e){this.message=e}y.prototype=new Error,y.prototype.name="InvalidTokenError";const T=function(e,t){if("string"!=typeof e)throw new y("Invalid token specified");var i=!0===(t=t||{}).header?0:1;try{return JSON.parse(g(e.split(".")[i]))}catch(e){throw new y("Invalid token specified: "+e.message)}};class w{customerToken=null;eventEmitter=new h.TypedEmitter;appWidget=null;refreshTimeout=null;retryCounter=0;constructor(e,t){this.config={appUrl:"https://tecsafe.github.io/app-ui/",...t},this.getCustomerTokenCallback=e,this.httpClient=new s((()=>{if(null===this.customerToken)throw new Error("missing customer token");return this.customerToken})),window.addEventListener("message",(e=>{this.listenMessage(e.data)}))}async initialize(){await this.reloadToken()}productDetailWidget(e,t,i){return new l(this,e,t,i)}cartWidget(e){return new c(this,e)}openApp(){return this.appWidget||(this.appWidget=new p(this)),this.appWidget}closeApp(){this.appWidget&&(this.appWidget.destroy(),this.appWidget=null)}async reloadToken(){try{const e=await this.getCustomerTokenCallback();if(e===this.customerToken)return;if(null===e)return void this.logout();const t=T(e);if(this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.refreshTimeout=setTimeout((()=>{this.reloadToken()}),1e3*(t.exp-30)-Date.now()),this.customerToken){if(T(this.customerToken).sub===t.sub)return this.customerToken=e,this.retryCounter=0,void this.eventEmitter.emit("refreshToken",e)}this.customerToken=e,this.retryCounter=0,this.eventEmitter.emit("customerChanged",e)}catch(e){if(console.error(e),this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.retryCounter<3)return console.warn(`retry in 5 seconds (${this.retryCounter+1}/3)`),this.retryCounter++,void(this.refreshTimeout=setTimeout((()=>{this.reloadToken()}),5e3));this.logout()}}logout(){this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.customerToken=null,this.eventEmitter.emit("customerLogout")}getCustomerToken(){return this.customerToken}async getCart(){return this.httpClient.get("/cart")}on(e,t){return this.eventEmitter.on(e,t),()=>{this.eventEmitter.off(e,t)}}off(e,t){this.eventEmitter.off(e,t)}emit(e,...t){this.eventEmitter.emit(e,...t)}listenMessage(e){switch(e.type){case"addToCart":this.eventEmitter.emit("addToCart",e.itemId,e.quantity,e.price);break;case"removeFromCart":this.eventEmitter.emit("removeFromCart",e.itemId);break;case"changeCartQuantity":this.eventEmitter.emit("changeCartQuantity",e.itemId,e.quantity,e.price);break;case"openApp":this.openApp();break;case"closeApp":this.closeApp()}}}const k={initializeTecsafeApi:async function(e,t){const i=new w(e,t);return await i.initialize(),i}};function b(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class v extends r.Z{constructor(...e){super(...e),b(this,"api",void 0)}async init(){this.api=await k.initializeTecsafeApi((async()=>{const e=await fetch("/tecsafe/ofcp/token");return(await e.json()).token}))}reloadToken(){this.api.reloadToken()}logout(){this.api.logout()}createProductDetailWidget(e){return this.api.productDetailWidget(e)}}window.PluginManager.register("Tecsafe",v,"[data-tecsafe-plugin]")},133:(e,t,i)=>{t.TypedEmitter=i(8728).EventEmitter}},e=>{e.O(0,["vendor-node","vendor-shared"],(()=>{return t=4223,e(e.s=t);var t}));e.O()}]);